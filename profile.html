<!DOCTYPE html>
<html lang="bg">

<head>
  <meta charset="UTF-8">
  <title>Профил | DesignRealm</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Profile page sidebar + layout */
    .layout {
      display: flex;
      gap: 1.5rem;
      max-width: 1100px;
      margin: 1.5rem auto;
      padding: 0 1rem;
    }

    .sidebar {
      width: 260px;
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    }

    .sidebar h3 {
      margin: 0 0 .75rem 0;
      font-size: .95rem;
    }

    .menu {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: .25rem;
    }

    .menu a {
      display: block;
      padding: .6rem .8rem;
      border-radius: 8px;
      color: var(--text-color, #222);
      text-decoration: none;
    }

    .menu a.active,
    .menu a:hover {
      background: #f3f4f6;
    }

    .content {
      flex: 1;
    }

    .top-actions {
      display: flex;
      gap: .5rem;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }

    .small {
      font-size: .9rem;
      color: #666
    }

    @media (max-width:860px) {
      .layout {
        flex-direction: column;
        padding: 0 0.75rem
      }

      .sidebar {
        width: 100%;
        order: 2
      }

      .content {
        order: 1
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">
      <a href="index.html">
        <img src="images/logo_notext.png" alt="DesignRealm Logo" class="logo-img">
        <span>DesignRealm</span>
      </a>
    </div>
    <nav id="nav">
      <a href="index.html">Начало</a>
      <a href="catalog.html">Каталог</a>
      <a href="profile.html" class="active">Профил</a>
    </nav>
    <button id="menu-toggle">☰</button>
  </header>


  <div class="layout">
    <aside class="sidebar" aria-label="Профил меню">
      <h3>Меню</h3>
      <ul class="menu" id="profile-menu">
        <li><a href="#overview" class="active">Преглед</a></li>
        <li><a href="uploads.html">Качвания</a></li>
        <li><a href="favorites.html">Любими</a></li>
        <li><a href="settings.html">Настройки</a></li>
        <li><a href="security.html">Сигурност</a></li>
      </ul>
      <div style="margin-top:1rem" class="small">Бързи действия</div>
      <div style="display:flex;gap:.5rem;margin-top:.5rem">
        <button class="btn" id="edit-profile">Редактирай</button>
        <button class="btn ghost" id="logout">Излез</button>
      </div>
    </aside>

    <main class="content">
      <section class="hero">
        <div class="hero-text">
          <h1>Вашият профил</h1>
          <p class="subtitle">Управлявайте информацията и настройките на своя акаунт.</p>
        </div>
      </section>

      <div class="top-actions">
        <div class="small">Статус: <strong id="profile-status">Активен</strong></div>
        <button class="btn" id="change-password">Промени парола</button>
        <button class="btn danger" id="delete-account">Изтрий акаунт</button>
      </div>

      <section class="card profile-card">
        <div style="display:flex;gap:1rem;align-items:center;">
          <img id="profileAvatar" src="images/avatar_placeholder.png" alt="avatar"
            style="width:96px;height:96px;border-radius:12px;object-fit:cover">

          <div>
            <p><strong>Email:</strong> <span id="profile-email">...</span></p>
            <p><strong>Роля:</strong> <span id="profile-role"></span></p>
            <a href="upload.html" class="btn">Качи модел</a>
          </div>
        </div>
      </section>

      <section id="overview" style="margin-top:1rem">
        <h3>Преглед</h3>
        <p class="small">Тук ще намерите основна информация за акаунта и бързи връзки.</p>
      </section>

      <a href="index.html" class="btn" style="margin-top:1rem;display:inline-block">← Начало</a>
    </main>
  </div>

  <footer>
    <p>© 2025 DesignRealm. Всички права запазени.</p>
  </footer>

  <script type="module">
    import { auth, db } from "./firebase-init.js";

    import {
      onAuthStateChanged,
      updateProfile,
      signOut,
      deleteUser,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    import {
      doc,
      getDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ===== ELEMENTS =====
    const avatarImg = document.getElementById("profileAvatar");
    const emailEl = document.getElementById("profile-email");
    const roleEl = document.getElementById("profile-role");

    const logoutBtn = document.getElementById("logout");
    const deleteBtn = document.getElementById("delete-account");
    const changePassBtn = document.getElementById("change-password");
    const editBtn = document.getElementById("edit-profile");

    let userRef;
    let currentUser;

    // ===== AUTH CHECK =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      userRef = doc(db, "users", user.uid);

      const snap = await getDoc(userRef);

      if (snap.exists()) {
        const data = snap.data();

        avatarImg.src = data.avatar || "images/avatar_placeholder.png";
        emailEl.textContent = user.email;
        roleEl.textContent = data.role || "user";
      } else {
        emailEl.textContent = user.email;
        roleEl.textContent = "user";
      }
    });

    // ===== EDIT PROFILE (simple prompt version) =====
    editBtn.addEventListener("click", async () => {
      const newName = prompt("Въведете ново име:", currentUser.displayName || "");

      if (!newName) return;

      await updateProfile(currentUser, {
        displayName: newName
      });

      await updateDoc(userRef, {
        displayName: newName,
        updatedAt: new Date()
      });

      alert("Името е обновено!");
    });

    // ===== CHANGE PASSWORD =====
    changePassBtn.addEventListener("click", async () => {
      await sendPasswordResetEmail(auth, currentUser.email);
      alert("Изпратен е имейл за смяна на парола.");
    });

    // ===== DELETE ACCOUNT =====
    deleteBtn.addEventListener("click", async () => {
      const confirmDelete = confirm("Сигурни ли сте, че искате да изтриете акаунта си?");

      if (!confirmDelete) return;

      await deleteDoc(userRef);
      await deleteUser(currentUser);

      alert("Акаунтът е изтрит.");
      window.location.href = "index.html";
    });

    // ===== LOGOUT =====
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });
  </script>


  <script type="module" src="monitor.js"></script>
</body>

</html>