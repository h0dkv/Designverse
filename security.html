<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сигурност | DesignRealm</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <div class="logo">
            <a href="index.html">
                <img src="images/logo_notext.png" alt="DesignRealm Logo">
                <span>DesignRealm</span>
            </a>
        </div>
        <nav id="nav">
            <a href="index.html">Начало</a>
            <a href="catalog.html">Каталог</a>
            <a href="profile.html">Профил</a>
            <a href="favorites.html">Любими</a>
            <a id="login-link" href="login.html">Вход</a>
            <a href="admin.html" id="admin-link" style="display:none;">Админ панел</a>
        </nav>
        <button id="menu-toggle">☰</button>
    </header>

    <main class="page">
        <section class="hero">
            <div class="hero-text">
                <h1>Сигурност на акаунта</h1>
                <p class="subtitle">Промяна на парола и управление на достъпа.</p>
            </div>
        </section>

        <section style="max-width:720px;margin:1.5rem auto;">
            <div class="card">
                <h3>Промени парола</h3>
                <form id="change-password-form">
                    <input type="password" id="current-password" placeholder="Текуща парола">
                    <input type="password" id="new-password" placeholder="Нова парола">
                    <button type="submit" class="btn">Промени парола</button>
                </form>

                <hr style="margin:1rem 0">

                <h3>Изтриване на акаунт</h3>
                <p class="small">Изтриването на акаунта е необратимо. Всички ваши модели и данни ще бъдат премахнати.
                </p>
                <button id="delete-account-btn" class="btn danger">Изтрий акаунт</button>
            </div>
        </section>
    </main>

    <footer>
        <p>© 2025 DesignRealm. Всички права запазени.</p>
    </footer>

    <script type="module" src="script.js"></script>
    <script type="module" src="dashboard.js"></script>
    <script type="module" src="firebase-init.js"></script>
    <script type="module" src="auth.js"></script>
    <script type="module" src="check.js"></script>
    <script type="module">
        import { auth, db } from './firebase-init.js';
        import {
            onAuthStateChanged,
            EmailAuthProvider,
            reauthenticateWithCredential,
            updatePassword,
            deleteUser
        } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
        import { collection, query, where, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

        const changeForm = document.getElementById('change-password-form');
        const deleteBtn = document.getElementById('delete-account-btn');

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        changeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const current = document.getElementById('current-password').value;
            const next = document.getElementById('new-password').value;
            if (!current || !next) return alert('Попълнете полетата');
            const user = auth.currentUser;
            if (!user) return alert('Трябва да сте влезли.');
            try {
                const cred = EmailAuthProvider.credential(user.email, current);
                await reauthenticateWithCredential(user, cred);
                await updatePassword(user, next);
                alert('Паролата е успешно променена.');
                changeForm.reset();
            } catch (err) {
                console.error('Password change failed', err);
                alert('Грешка: ' + (err.message || err.code));
            }
        });

        deleteBtn.addEventListener('click', async () => {
            const ok = confirm('Наистина ли искате да изтриете акаунта си? Тази операция изтрива всички ваши данни.');
            if (!ok) return;
            const user = auth.currentUser;
            if (!user) return alert('Трябва да сте влезли.');
            try {
                // delete user's models
                const q = query(collection(db, 'models'), where('ownerId', '==', user.uid));
                const snaps = await getDocs(q);
                for (const d of snaps.docs) {
                    await deleteDoc(doc(db, 'models', d.id));
                }
                // delete user doc
                await deleteDoc(doc(db, 'users', user.uid));
                // delete auth user
                await deleteUser(user);
                alert('Акаунтът е изтрит.');
                window.location.href = 'index.html';
            } catch (err) {
                console.error('Account deletion failed', err);
                if (err && err.code === 'auth/requires-recent-login') {
                    alert('За сигурност — моля, влезте отново и опитайте пак.');
                    return;
                }
                alert('Грешка при изтриване: ' + (err.message || err.code));
            }
        });
    </script>
    <script type="module" src="monitor.js"></script>
</body>

</html>